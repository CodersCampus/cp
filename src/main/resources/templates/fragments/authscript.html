
<script th:inline="javascript" type="module" defer>
    const elements = {
        auth: document.querySelector('fbauth-element'),
        uid: document.getElementById('uid'),
        studentName: document.getElementById('student-name'),
        displayName: document.getElementById('display-name'),
        photoURL: document.getElementById('photo-url'),
    }

    const updateUserInfo = (userData) => {
        if (elements.uid) {
            elements.uid.value = userData?.uid || '';
        }
        if (elements.displayName) {
            elements.displayName.value = userData?.displayName || '';
        }
        elements.studentName.innerText = userData?.displayName || '';
        elements.photoURL.src = userData?.photoURL || '';
    }

    const postUserData = async (userData) => {
        const data = {
            displayName: userData.displayName,
            uid: userData.uid,
            photoURL: userData.photoURL,
            email: userData.email,
        };

        try {
            const response = await fetch("/send-oauth", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
                console.log('Authentication successful:', result.message);
                // Redirect to dashboard or update UI as needed
                window.location.href = '/dashboard';
            } else {
                console.error('Authentication failed:', result.message);
            }

            return result;
        } catch (error) {
            console.error('Error sending user data to server:', error);
            throw error;
        }
    }

    const signOut = async () => {
        try {
            const response = await fetch("/signout", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
            });

            const result = await response.json();

            if (result.success) {
                console.log('Signed out successfully');
                // Clear local user data
                updateUserInfo(null);
                // Redirect to login page
                window.location.href = '/login';
            } else {
                console.error('Signout failed:', result.message);
            }

            return result;
        } catch (error) {
            console.error('Error during signout:', error);
            throw error;
        }
    }

    // Listen for authentication state changes
    elements.auth.addEventListener('user-changed', async (event) => {
        const {newValue} = event.detail;

        updateUserInfo(newValue);

        if (newValue) {
            // User signed in
            try {
                await postUserData(newValue);
            } catch (error) {
                console.error('Failed to send OAuth data:', error);
            }
        } else {
            // User signed out
            try {
                await signOut();
            } catch (error) {
                console.error('Failed to complete signout:', error);
            }
        }
    });

    // Expose signOut function globally for use in UI
    window.userSignOut = signOut;

    // Check authentication status on page load
    const checkAuthStatus = async () => {
        try {
            const response = await fetch("/auth/status");
            const result = await response.json();

            if (result.authenticated) {
                updateUserInfo(result.user);
            }
        } catch (error) {
            console.error('Error checking auth status:', error);
        }
    };

    // Check auth status when page loads
    document.addEventListener('DOMContentLoaded', checkAuthStatus);
</script>